این پروپوزال فنی برای ایجاد سیستم **Matrix-Plus** تنظیم شده است. هدف این پروژه، ایجاد یک زیرساخت توزیع‌شده و مستقل (Decentralized) برای پیام‌رسان ماتریکس است که در محیط‌های ایزوله (بدون نیاز به Let's Encrypt) با تکیه بر یک زنجیره اعتماد اختصاصی کار می‌کند.

---

# پروپوزال فنی پروژه Matrix-Plus

**عنوان:** سیستم مدیریت ماژولار و یکپارچه نصب ماتریکس با قابلیت Private Federation

## ۱. اهداف پروژه

* **استقلال کامل:** حذف وابستگی به مرجع صدور گواهی خارجی (CA) برای کار در شبکه‌های ایزوله.
* **ماژولار بودن:** امکان اضافه کردن متدهای مختلف نصب (Synapse, Dendrite, وغیره) به عنوان Addon.
* **یکپارچگی هویت:** برقراری ارتباط (Federation) بین سرورهای مختلف از طریق یک Root CA مشترک.
* **سادگی در اجرا:** کاهش تعامل کاربر (Interactive) به حداقل ممکن.

---

## ۲. معماری سیستم (System Architecture)

پروژه از سه لایه اصلی تشکیل شده است:

### لایه اول: Main Orchestrator (مدیریت مرکزی)

این لایه در فایل `main.sh` پیاده‌سازی می‌شود و وظایف زیر را بر عهده دارد:

* **SSL Manager:** تولید Root CA (در صورت عدم وجود) و امضای گواهی‌های اختصاصی برای افزونه‌ها.
* **Addon Loader:** شناسایی خودکار پوشه‌های موجود در دایرکتوری پروژه و نمایش منوی انتخاب.
* **Environment Provider:** تزریق داده‌های حساس SSL به افزونه‌ها.

### لایه دوم: Addons (ماژول‌های نصب)

هر پوشه (مانند `zanjir-dendrite`) یک واحد مستقل است.

* دارای یک `install.sh` استاندارد که ورودی‌های خود را فقط از متغیرهای محیطی (Env Vars) می‌گیرد.
* مسئولیت نصب پکیج‌ها، تنظیم داکر و پیکربندی داخلی سرویس ماتریکس.

### لایه سوم: Infrastructure (زیرساخت گواهی‌ها)

پوشه `certs/` که مخزن کلیدهای حیاتی است. این پوشه پل ارتباطی بین سرورهای مختلف در شبکه Federation خواهد بود.

---

## ۳. استاندارد تبادل داده (The Protocol)

برای اینکه شبکه Federation بدون نقص کار کند، `main.sh` متغیرهای زیر را با استانداردهای پروژه اول (Ansible-SSL) آماده کرده و به افزونه پاس می‌دهد:

| متغیر | مقدار | نقش در Federation |
| --- | --- | --- |
| `SERVER_NAME` | `ip` یا `domain` | هویت سرور در شبکه ماتریکس |
| `SSL_CERT` | مسیر فایل `.crt` | گواهی تایید شده با SAN (IP & DNS) |
| `SSL_KEY` | مسیر فایل `.key` | کلید خصوصی جهت رمزنگاری TLS |
| `ROOT_CA` | مسیر `rootCA.crt` | لنگر اعتماد برای تایید سایر سرورها |

---

## ۴. جریان کاری اسکریپت (Workflow)

1. **ورود (Entry):** اجرای `./main.sh`.
2. **بررسی هویت (Identity Check):**
* اگر `rootCA.key` موجود باشد: لود کردن شبکه موجود.
* اگر موجود نباشد: پرسش برای ساخت شبکه جدید یا وارد کردن Root CA خارجی.


3. **انتخاب سرویس:** نمایش لیست افزونه‌های موجود در فولدر پروژه.
4. **تولید گواهی (Automated Signing):** گرفتن نام سرور از کاربر و تولید گواهی امضا شده با SAN.
5. **اجرای نصب (Deployment):** انتقال کنترل به `install.sh` افزونه.

---

## ۵. تضمین عملکرد Federation (مانند پروژه اول)

برای جلوگیری از خراب شدن Federation، لایه SSL در `main.sh` موارد زیر را تضمین می‌کند:

* استفاده از تنظیمات `v3_ca` برای تولید Root CA.
* درج آدرس IP و دامنه در بخش `subjectAltName` گواهی سرور.
* اعتبار زمانی بلندمدت (مثلاً ۱۰ سال برای Root و ۱ سال برای سرورها).

---

## ۶. ساختار نهایی دایرکتوری

```text
/matrix-plus
├── main.sh                # مدیریت منو، منطق SSL و اجرای افزونه‌ها
├── certs/                 # محل نگهداری Root CA و گواهی‌های صادر شده
├── zanjir-dendrite/       # افزونه اول (نسخه بهینه شده برای دریافت SSL)
│   ├── install.sh
│   └── docker-compose.yml
└── synapse-ansible/       # افزونه دوم (نسخه تطبیق یافته با ساختار جدید)
    ├── install.sh
    └── ...

```

# Zanjir Synapse (Private Key + Dendrite)

[Zanjir](https://github.com/MatinSenPai/Zanjir/) is a lightweight Matrix homeserver powered by Dendrite with Private Key SSL certificates from matrix-installer.sh. It includes an admin panel, voice/video calls support, and a fully translated Persian interface.

## Version

1.0.0

## Description

This addon provides a fast, Docker Compose-based installation of Zanjir Matrix Server using private key SSL certificates generated by matrix-installer.sh. Zanjir uses Dendrite (a lightweight Matrix homeserver) instead of Synapse, making it ideal for resource-constrained environments. It features a web-based admin panel, built-in TURN server for voice/video calls, and Element Web client.

## Features

- **Lightweight Homeserver**: Dendrite â€” lighter than Synapse, perfect for 2GB VPS
- **Admin Panel**: Web-based admin dashboard with user management and audit logging
- **Voice/Video Calls**: Built-in TURN server (coturn) for reliable NAT traversal
- **Private Key SSL**: Uses your custom Root Key certificates
- **IP or Domain Support**: Works with IP addresses or custom domains
- **Element Web**: Modern, responsive Matrix client with Persian UI
- **Open Registration**: Users can self-register via web interface
- **Auto-Configuration**: Automatically configures all services

## Requirements

### Software
- Docker
- Docker Compose (v2)
- openssl

### Certificates (from matrix-installer.sh)
- Root Key certificate
- Server certificate (full chain)
- Server private key

**Note**: You must generate server certificates in matrix-installer.sh before running this addon.

### Network
- Port 443 accessible (for HTTPS)
- Ports 3478, 5349 UDP (for voice/video calls)
- Port 8080 for optional access

## Installation

### Step 1: Generate Root Key and Server Certificate

From matrix-installer.sh:

1. Generate Root Key (if not exists)
2. Generate server certificate for your IP or domain

```bash
./matrix-installer.sh
# Option 1: Generate server certificate
# Enter your server IP or domain
```

### Step 2: Install Zanjir

From matrix-installer.sh menu, select "Install Zanjir Synapse (Private Key+Dendrite)"

Or execute directly (after generating certificates):

```bash
./script/addons/zanjir/install.sh
```

Follow the prompts to configure:
1. HTTPS port (default: 443, or custom port)
2. Confirm installation settings

## After Installation

### Installation Summary

After successful installation, you will see:

```
========================================
ZANJIR INSTALLATION COMPLETE
========================================

Server Information:
  - Server: 172.19.39.69
  - Homeserver: Dendrite
  - Installation: Docker Compose with Private Key SSL

Access URLs:
  - Element Web: https://your-server-ip-or-domain
  - Admin Panel: https://your-server-ip-or-domain/admin
  - Turn Server: turn:your-server-ip-or-domain:3478

SSL Certificates:
  - Certificate: /opt/zanjir/ssl/cert-full-chain.pem
  - Private Key: /opt/zanjir/ssl/server.key
  - Root Key: /opt/zanjir/ssl/rootCA.crt

Docker Compose:
  - Location: /opt/zanjir
  - Control: cd /opt/zanjir && docker compose [up|down|logs]
========================================
```

### Access URLs
- **Element Web**: `https://your-server-ip-or-domain`
- **Admin Panel**: `https://your-server-ip-or-domain/admin`

### Create Admin User

After installation, create your admin account:

```bash
cd /opt/zanjir
docker exec -it zanjir-dendrite /usr/bin/create-account \
    --config /etc/dendrite/dendrite.yaml \
    --username admin \
    --admin
```

You'll be prompted to set a password.

### Docker Compose Management
```bash
cd /opt/zanjir

# View logs
docker compose logs -f

# Restart services
docker compose restart

# Stop services
docker compose down

# Start services
docker compose up -d
```

## User Registration

Users can self-register through Element Web:

1. Visit `https://your-server-ip-or-domain`
2. Click **"Create account"**
3. Fill in username and password
4. Start messaging!

Or disable registration by editing `dendrite.yaml`:
```yaml
registration_disabled: true
```

## Admin Panel

### Access

Visit: `https://your-server-ip-or-domain/admin`

Login with your admin account credentials.

### Features

#### Dashboard
- Total users count
- Active users
- Total rooms

#### User Management
- View all users
- Disable user accounts
- Delete users
- View user status

#### Audit Logs
- Track all admin actions
- Timestamps and IP addresses
- Target user tracking
- Detailed action logs

## Voice/Video Calls

Zanjir includes a TURN server (coturn) for reliable voice/video calls.

### Required Ports

| Port | Protocol | Purpose |
|------|----------|---------|
| 3478 | UDP | STUN/TURN |
| 5349 | UDP | TURN-TLS |

### Firewall Configuration

```bash
sudo ufw allow 3478/udp
sudo ufw allow 5349/udp
```

### Testing Calls

1. Create two accounts
2. Create a room, invite both users
3. Click phone/video icon
4. Accept call on other end

## Client Trust Configuration

Since this addon uses a custom Root Key, clients must trust your Root Key certificate to avoid SSL warnings.

### Root Key Location
- **Server**: `/opt/zanjir/ssl/rootCA.crt`
- **Source**: `certs/rootCA.crt` (from matrix-installer.sh directory)

### Installing Root Key on Clients

#### Linux
```bash
sudo cp /opt/zanjir/ssl/rootCA.crt /usr/local/share/ca-certificates/matrix-root-ca.crt
sudo update-ca-certificates
```

#### macOS
```bash
sudo security add-trusted-cert -d -r trustRoot \
  -k /Library/Keychains/System.keychain \
  /opt/zanjir/ssl/rootCA.crt
```

#### Windows
1. Copy `/opt/zanjir/ssl/rootCA.crt` to Windows machine
2. Right-click > Install Certificate
3. Select "Local Machine" > Next
4. Select "Place all certificates in the following store"
5. Browse to "Trusted Root Certification Authorities"
6. Complete the wizard

#### Android
1. Copy `rootCA.crt` to device storage
2. Settings > Security > Install from storage
3. Select the certificate file
4. Enter a name and confirm

#### iOS
1. Copy `rootCA.crt` to device (via AirDrop, Files, etc.)
2. Settings > General > About > Certificate Trust Settings
3. Enable full trust for your Root Key

## Services

| Service | Image | Description | Port |
|---------|-------|-------------|------|
| **Dendrite** | ghcr.io/matrix-org/dendrite-monolith:latest | Matrix homeserver | 8008 |
| **PostgreSQL** | postgres:15-alpine | Database backend | 5432 |
| **Nginx** | nginx:alpine | Reverse proxy & SSL termination | 443 |
| **Element** | vectorim/element-web:latest | Web client | 80 |
| **Admin Panel** | zanjir-admin:latest | Admin interface | 80 |
| **Coturn** | coturn/coturn:latest | TURN server for calls | 3478, 5349 |

## Differences from Original Zanjir

This addon is adapted from the original [Zanjir project](https://github.com/MatinSenPai/Zanjir/) for integration with matrix-installer.sh. Here are the key differences:

| Component | Original Zanjir | This Addon |
|-----------|----------------|------------|
| **Reverse Proxy** | Caddy (with auto HTTPS) | Nginx (with Private Key SSL) |
| **SSL Certificates** | Let's Encrypt or self-signed | Private Key from matrix-installer.sh |
| **Installation** | Standalone script | Integrated with matrix-installer.sh |
| **Certificate Management** | Built-in (Caddy) | Manual via matrix-installer.sh |

### Why Nginx instead of Caddy?

- **Caddy** uses automatic HTTPS (Let's Encrypt) which requires a public domain
- **Nginx** with Private Key SSL allows:
  - IP-based deployments (no domain required)
  - Private network setups
  - Custom Root Key control
  - Federation between servers with same Root Key

The addon uses Nginx to leverage matrix-installer.sh's Private Key SSL infrastructure, enabling deployments without public DNS or domains.

## Technical Details

### Homeserver: Dendrite vs Synapse

Dendrite is a lightweight Matrix homeserver written in Go:

| Feature | Dendrite | Synapse |
|---------|----------|---------|
| **Language** | Go | Python |
| **Memory Usage** | ~100-200MB | ~500MB-1GB |
| **CPU Usage** | Lower | Higher |
| **Federation** | Experimental support | Full support |
| **Features** | Core Matrix | Full Matrix + extensions |

**Zanjir uses Dendrite** for:
- Lower resource requirements
- Simpler setup
- Faster deployment
- Ideal for small deployments (100-500 users)

### PostgreSQL Configuration

Zanjir uses PostgreSQL with UTF-8 encoding:

```yaml
environment:
  - POSTGRES_INITDB_ARGS=-E UTF8
```

### Element Web Configuration

Persian UI with open registration enabled:

```json
{
  "UIFeature.registration": true,
  "show_labs_settings": true
}
```

## Comparison with Other Addons

| Feature | Zanjir (Dendrite) | docker-synapse-root-key (Synapse) | ansible-synapse |
|---------|-------------------|-----------------------------------|------------------|
| **Homeserver** | Dendrite | Synapse | Synapse |
| **Memory Usage** | ~100-200MB | ~500MB-1GB | ~500MB-1GB |
| **Admin Panel** | Built-in | Synapse Admin (separate) | Synapse Admin |
| **Voice/Video** | Built-in TURN | Optional | Optional |
| **Persian UI** | Full | Partial | Partial |
| **User Registration** | Built-in web | Via API | Via API |
| **Resource Needs** | 2GB RAM | 4GB RAM recommended | 4GB RAM recommended |

### When to Use Zanjir
- Resource-constrained environments (2GB VPS)
- Small deployments (100-500 users)
- Persian-speaking users
- Need for built-in admin panel
- Voice/video calls required
- Quick deployment needed

### When to Use docker-synapse-root-key
- Need for full Matrix features
- Larger deployments (500+ users)
- Federation required
- Synapse-specific features needed

## Troubleshooting

### Registration Not Working

**Check:**
1. Verify `dendrite.yaml`: `registration_disabled: false`
2. Check `element-config.json`: `"UIFeature.registration": true`
3. Restart containers:
   ```bash
   cd /opt/zanjir
   docker compose restart
   ```

### Voice Calls Failing

**Solutions:**
1. Check TURN server is running:
   ```bash
   docker ps | grep coturn
   ```
2. Verify firewall allows UDP 3478, 5349
3. Check TURN secret in `.env` matches `dendrite.yaml`

### Admin Panel Login Fails

**Solutions:**
1. Verify user is admin:
   ```bash
   docker exec -it zanjir-dendrite /usr/bin/create-account \
       --config /etc/dendrite/dendrite.yaml \
       --username YOUR_USERNAME \
       --admin
   ```
2. Check admin container logs:
   ```bash
   docker logs zanjir-admin
   ```

### Dendrite Won't Start

```bash
# Check logs
cd /opt/zanjir
docker compose logs dendrite

# Restart all services
docker compose restart
```

### Port Already in Use

**Solution:** Reinstall with custom port, or change port in `.env`:
```bash
nano /opt/zanjir/.env
# Change HTTPS_PORT and HTTP_PORT
docker compose down
docker compose up -d
```

## Uninstallation

From the addon menu, select "Uninstall Zanjir" or run:

```bash
cd /opt/zanjir
docker compose down -v
cd /
rm -rf /opt/zanjir
```

## Security Notes

1. **Root Privileges**: This addon requires root access for system configuration
2. **Certificate Security**: Private keys are stored with restrictive permissions (600)
3. **Client Trust**: All clients must trust your Root Key
4. **Firewall**: Ports 443, 3478, 5349 must be open
5. **Auto-generated Secrets**: All passwords and secrets are randomly generated

## Performance

### User Capacity

| VPS RAM | Recommended Users |
|---------|-------------------|
| 2GB | 100-500 users |
| 4GB | 500-1000 users |

### Backup

Backup Docker volumes:

```bash
docker run --rm \
  -v zanjir-postgres-data:/data \
  -v $(pwd):/backup \
  ubuntu tar czf /backup/postgres-backup.tar.gz /data
```

## License

Part of Matrix Installer project.

## Author

Based on [Zanjir](https://github.com/MatinSenPai/Zanjir/) by MatinSenPai

## Project Links

- **Zanjir Repository**: [https://github.com/MatinSenPai/Zanjir/](https://github.com/MatinSenPai/Zanjir/)
- **Matrix Installer**: [https://github.com/Amm1rr/matrix-installer](https://github.com/Amm1rr/matrix-installer)

## Acknowledgments

- [Zanjir Project](https://github.com/MatinSenPai/Zanjir/) - Original Zanjir server
- [Dendrite](https://github.com/matrix-org/dendrite) - Lightweight Matrix homeserver
- [Element](https://element.io/) - Web client
- [Coturn](https://github.com/coturn/coturn) - TURN server
- [Nginx](https://nginx.org/) - Reverse proxy

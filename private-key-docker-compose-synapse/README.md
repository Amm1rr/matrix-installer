# private-key-docker-compose-synapse

Docker Compose installer for Matrix Synapse with Private Key SSL certificates (Root CA from main.sh).

## Version

1.1.0

## Description

This addon provides a fast, Docker Compose-based installation of Matrix Synapse using private key SSL certificates generated by main.sh. It uses your custom Root CA for secure, private deployments without requiring public domain names or Let's Encrypt.

## Features

- **Fast Installation**: Deploys in ~2-3 minutes
- **Private Key SSL**: Uses your custom Root CA certificates
- **IP or Domain Support**: Works with IP addresses or custom domains
- **Full Stack**: Synapse, PostgreSQL, Traefik, Element Web, Synapse Admin
- **Root Execution**: Runs with root privileges for system-level configuration
- **Auto-Configuration**: Automatically configures PostgreSQL locale, Synapse settings, and Traefik routing

## Requirements

### Software
- Docker
- Docker Compose (v2)
- openssl

### Certificates (from main.sh)
- Root CA certificate
- Server certificate (full chain)
- Server private key

**Note**: You must generate server certificates in main.sh before running this addon.

### Network
- Port 443 accessible (for HTTPS)
- Port 8080 for Traefik dashboard (optional)

## Installation

### Step 1: Generate Root CA and Server Certificate

From main.sh:

1. Generate Root CA (if not exists)
2. Generate server certificate for your IP or domain

```bash
./main.sh
# Option 1: Generate server certificate
# Enter your server IP or domain
```

### Step 2: Install Matrix

From main.sh menu, select "Install private-key-docker-compose-synapse"

Or execute directly (after generating certificates):

```bash
./script/private-key-docker-compose-synapse/install.sh
```

Follow the prompts to configure:
1. Max registrations per invite (default: 5)
2. Enable/disable user registration

## After Installation

### Installation Summary

After successful installation, you will see:

```
========================================
PRIVATE-KEY-DOCKER-COMPOSE-SYNAPSE INSTALLATION COMPLETE
========================================

Server Information:
  - Server: 172.19.39.69
  - Installation: Docker Compose with Private Key SSL

Admin User:
  - Username: admin
  - Password: [auto-generated]

Access URLs:
  - Element Web: https://your-server-ip-or-domain
  - Admin UI: https://your-server-ip-or-domain/admin
  - Traefik Dashboard: http://your-server-ip-or-domain:8080

Registration:
  - Shared Secret: [auto-generated]
  - Max Per Invite: 5
  - Enabled: true

SSL Certificates:
  - Certificate: /opt/matrix/ssl/cert-full-chain.pem
  - Private Key: /opt/matrix/ssl/server.key
  - Root CA: /opt/matrix/ssl/rootCA.crt

Docker Compose:
  - Location: /opt/matrix
  - Control: cd /opt/matrix && docker compose [up|down|logs]
========================================
```

### Access URLs
- **Element Web**: `https://your-server-ip-or-domain`
- **Admin UI**: `https://your-server-ip-or-domain/admin`
- **Traefik Dashboard**: `http://your-server-ip-or-domain:8080`

### Default Admin User
- **Username**: `admin`
- **Password**: Auto-generated (shown after installation)

### Docker Compose Management
```bash
cd /opt/matrix

# View logs
docker compose logs -f

# Restart services
docker compose restart

# Stop services
docker compose down

# Start services
docker compose up -d
```

## Client Trust Configuration

Since this addon uses a custom Root CA, clients must trust your Root CA certificate to avoid SSL warnings.

**Note**: This information is provided for reference. The installation script does not display these instructions.

### Root CA Location
- **Server**: `/opt/matrix/ssl/rootCA.crt`
- **Source**: `certs/rootCA.crt` (from main.sh directory)

### Installing Root CA on Clients

#### Linux
```bash
sudo cp /opt/matrix/ssl/rootCA.crt /usr/local/share/ca-certificates/matrix-root-ca.crt
sudo update-ca-certificates
```

#### macOS
```bash
sudo security add-trusted-cert -d -r trustRoot \
  -k /Library/Keychains/System.keychain \
  /opt/matrix/ssl/rootCA.crt
```

#### Windows
1. Copy `/opt/matrix/ssl/rootCA.crt` to Windows machine
2. Right-click > Install Certificate
3. Select "Local Machine" > Next
4. Select "Place all certificates in the following store"
5. Browse to "Trusted Root Certification Authorities"
6. Complete the wizard

#### Android
1. Copy `rootCA.crt` to device storage
2. Settings > Security > Install from storage
3. Select the certificate file
4. Enter a name and confirm

#### iOS
1. Copy `rootCA.crt` to device (via AirDrop, Files, etc.)
2. Settings > General > About > Certificate Trust Settings
3. Enable full trust for your Root CA

### Element Web Configuration

Element Web will require SSL trust. After installing Root CA:

- **Desktop browsers**: Restart browser after installing Root CA
- **Mobile apps**: Install Root CA in device settings

## Technical Details

### PostgreSQL Configuration

The addon automatically configures PostgreSQL with the correct locale for Synapse:

```yaml
environment:
  - POSTGRES_INITDB_ARGS=-E UTF8 --locale=C
```

This ensures compatibility with Synapse requirements.

### Synapse Configuration

The following configurations are automatically applied:

**IP-based servers** (when using an IP address):
- `federation_verify_certificates: false`
- `suppress_key_server_warning: true`
- `trusted_key_servers: []`
- `allow_unsafe_locale: true` (database config)

**Registration**:
- `enable_registration: true` (or false based on installation choice)
- `enable_registration_without_verification: true` (required for newer Synapse versions)

### Services

| Service | Image | Description | Port |
|---------|-------|-------------|------|
| **Synapse** | ghcr.io/matrix-org/synapse:latest | Matrix homeserver | 8008 |
| **PostgreSQL** | postgres:15-alpine | Database backend | 5432 |
| **Traefik** | traefik:v3.6 | Reverse proxy & SSL termination | 443, 8080 |
| **Element** | vectorim/element-web:latest | Web client | 80 |
| **Synapse Admin** | awesometechnologies/synapse-admin:latest | Admin interface | 80 |

## Registration Configuration

### Shared Secret
A registration shared secret is auto-generated during installation. Find it in:
- `/opt/matrix/data/synapse/homeserver.yaml`

### Max Registrations Per Invite
Controls how many times a single invite token can be used. Default: 5

### Enable/Disable Registration
User registration can be enabled or disabled during installation.

## Troubleshooting

### Synapse Won't Start - Database Collation Error

**Error**: `Database has incorrect collation of 'en_US.utf8'. Should be 'C'`

**Solution**: The installation script automatically configures PostgreSQL with the correct locale. If you see this error, it means the database was created before this fix. Reinstall:

```bash
cd /opt/matrix
docker compose down -v
sudo rm -rf /opt/matrix
```

Then run the installation again.

### Bad Gateway Error

**Symptoms**: Browser shows "502 Bad Gateway"

**Possible Causes**:

1. **Synapse not ready**: Wait a minute and refresh
2. **Element service port mismatch**: Check if Element container is running:
   ```bash
   docker compose ps element
   ```

3. **Check Traefik logs**:
   ```bash
   docker compose logs traefik
   ```

### Admin User Creation Fails

If admin user creation shows a warning, you can create it manually:

```bash
cd /opt/matrix
docker compose exec synapse register_new_matrix_user -u admin -p YOUR_PASSWORD -a -c /data/homeserver.yaml
```

### Cannot Access with Domain

1. Check DNS resolution: `ping your-domain`
2. For local testing, add to `/etc/hosts`:
   ```
   server-ip your-domain
   ```

### SSL Certificate Issues

If clients show SSL warnings:

1. Verify Root CA is installed on client
2. Restart browser/app after installing Root CA
3. Clear browser cache
4. Check certificate chain:

```bash
openssl s_client -connect your-server:443 -showcerts
```

### Container Not Starting

```bash
# Check logs
cd /opt/matrix
docker compose logs [service-name]

# Restart all services
docker compose restart
```

## Uninstallation

From the addon menu, select "Uninstall Matrix" or run:

```bash
cd /opt/matrix
docker compose down -v
cd /
rm -rf /opt/matrix
```

## Comparison Table

| Feature | private-key-docker-compose-synapse | docker-compose-synapse | ansible-synapse |
|---------|-----------------------------------|----------------------|-----------------|
| **Speed** | ~2-3 minutes | ~2-5 minutes | ~10-20 minutes |
| **SSL** | Private Key (Root CA) | Let's Encrypt | Private Key (Root CA) |
| **Target** | Local only | Local only | Local OR remote |
| **Domain** | IP or custom domain | DuckDNS only | IP or domain |
| **DuckDNS** | Not required | Required | Not required |
| **Complexity** | Simple | Simple | Flexible |
| **PostgreSQL Locale** | Auto-configured (C) | Default | Manual |
| **Traefik Version** | v3.6 | v3.6 | v2.10 |

### When to Use private-key-docker-compose-synapse
- Private network deployments
- IP-based servers without public DNS
- Custom domain with private SSL
- When you control all client devices
- Quick testing with custom certificates
- Development environments

### When to Use docker-compose-synapse
- Public-facing servers
- DuckDNS users
- When automatic SSL is preferred
- When clients can't install custom CA

### When to Use ansible-synapse
- Production deployments
- Remote server installation
- Need for advanced configuration
- Multi-service deployment

## SSL Certificates

This addon uses **Private Key SSL** from main.sh. Certificates are:
- Generated by main.sh Root CA
- Copied to `/opt/matrix/ssl/`
- Used by Traefik for TLS termination

**Certificate Files**:
- `cert-full-chain.pem` - Full certificate chain
- `server.key` - Private key
- `rootCA.crt` - Root CA certificate (for client distribution)

## Security Notes

1. **Root Privileges**: This addon requires root access for system configuration
2. **Certificate Security**: Private keys are stored with restrictive permissions (600)
3. **Client Trust**: All clients must trust your Root CA
4. **Firewall**: Port 443 must be open for HTTPS access
5. **Auto-generated Secrets**: All passwords and secrets are randomly generated during installation

## License

Part of Matrix Plus project.

## Author

Matrix Plus Team
